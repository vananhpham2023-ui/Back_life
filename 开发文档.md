下面是一份面向 Android 的移动应用开发**需求清单（PRD 级别）**，覆盖“从领回来（接纳现状）到一起走（微启动 + 正向循环）”的完整流程。定位为：**帮助用户从‘知道但动不了’的状态，转入‘可开始、可持续’的行动系统**（非医疗诊断类产品）。

------

## 0. 产品定位与目标

**产品名称（暂定）**：领回来 · 一起走
**核心价值主张**：把“拖延/逃避的自己（梦里的‘孩子’）领回来”，用**极小可成功的启动**建立“我能开始”的信心，再通过**游戏化但不成瘾**的反馈，把行动变得轻盈可持续。

**关键问题（来自对话）**

- 用户并非不想努力，而是被“羞耻/失败恐惧”卡住，转向游戏等低风险活动。
- 需要的不是更多理论，而是一个能**打破行动瘫痪**的“最小启动按钮” + 温和支持系统。
- “领回来”= 停止内战、承认现状、把逃避部分当成要引导的对象，而不是敌人。

**北极星指标（North Star）**

- **有效启动次数/周**（完成任意一次“最小启动”即计入）

------

## 1) 核心功能模块划分与详细需求

### A. 引导与建档（Onboarding & Profile）

**目标**：低门槛、低羞耻、快速进入可用状态
**需求**

- 30 秒快速建档：昵称/头像（可选）、常用目标类型（学习/论文/求职/自律/生活整理等）、常见卡点（拖延、完美主义、害怕评价、情绪低落等多选）。
- “我的语言偏好”：更温柔/更直接/更简短（影响文案风格）。
- 隐私选择：本地模式（默认）、云同步（可选）、是否需要“支持者”功能（可选）。
- 新手任务：引导完成一次“最小启动（≤5分钟）”。

### B. “领回来”仪式（Acceptance Ritual）

**目标**：从自责/对抗转为接纳与可行动
**需求**

- 1 分钟“领回来”流程（可跳过，但建议每日首次打开触发）：
  1. 状态选择：我现在更像（想逃避/很焦虑/没力气/还好）
  2. 一句接纳语（可自定义）：例如“我允许自己现在不想开始，但我可以做一个很小的动作。”
  3. 选择“今天要领回的部分”（拖延的我/害怕失败的我/沉迷游戏的我…）
- 结果：自动推荐“最小启动按钮”任务（见模块C）
- 禁用羞辱型措辞：不出现“你又失败了/你不自律”之类文案

### C. 最小启动按钮（Micro-Start Button）

**目标**：把“开始”拆到小到不会失败
**需求**

- 一键生成任务：**仅 1 个动作、≤5 分钟、可中断**
  - 示例模板：打开文档并只写标题；打开资料夹并浏览 1 页；列 3 个小点；整理桌面 3 分钟
- 支持三种启动模式：
  1. **看一眼**（30–60 秒）
  2. **动一下**（2–5 分钟）
  3. **走两步**（10 分钟，解锁条件：已连续完成 2 次“动一下”）
- 内置计时器（可暂停/提前完成）
- 完成后立即反馈：经验值 + 一句鼓励 + “允许回去玩/休息”的许可按钮（减少内疚反弹）
- 失败/中断处理：只记录“尝试”，不扣分、不清零

### D. 任务系统（Plans & Missions）

**目标**：把计划变成“可执行粒度”的任务链
**需求**

- 目标（Goal）→ 任务（Mission）→ 启动步（Step）
- 支持“任务切片”：把一个任务拆成多个≤10分钟的启动步
- 今日任务列表默认只展示 3 条（避免压迫感），其余折叠为“稍后”
- 智能推荐：根据最近完成记录，推荐更小的下一步
- 任务库模板：论文/考试/求职/技能学习/生活整理等

### E. 游戏化反馈（但不成瘾）（Progress & Rewards）

**目标**：用即时反馈替代游戏的“即时奖励”
**需求**

- 经验值 XP：按启动次数计，时长只做轻量加成（避免卷时长）
- 等级/徽章：以“开始次数”“连续尝试天数”“从中断回归次数”为主
- “100 XP 自定义奖励”：用户自定义奖励清单（看电影/买书/散步等）
- **不做**强刺激抽卡、强社交攀比排行榜（避免成瘾与羞耻）

### F. 行动日志与复盘（Log & Reflection）

**目标**：建立“我能开始”的证据库
**需求**

- 每日两条记录（对话提到的结构）：
  - 今日启动：我启动了什么？（自动生成）
  - 小成就/灵感：一句话即可
- 周复盘：本周启动次数、最有效的触发条件（时间/地点/任务类型）
- “羞耻触发记录”（可选）：我害怕的评价是什么？（私密，仅自己可见）

### G. 温和外部联结（Support & Accountability）

**目标**：把“渴望关注”转为“建设性支持”
**需求**

- 支持者角色（好友/家人/同学/导师）：只看到用户**愿意共享**的内容
- 共享机制（可配置）：
  - 仅共享“我今天启动了（是/否）”
  - 共享“我完成了哪类任务”（不共享具体内容）
  - 用户可一键隐藏/暂停共享
- 支持者互动：
  - 预设鼓励语（避免说教）
  - “给我一个👍就好”轻反馈
  - 不允许支持者发送负向评价模板（产品侧限制）

### H. 场景化“离开房间”（Environment Switch）

**目标**：用环境改变打破停滞
**需求**

- “换个地点启动”挑战：选择一个地点（客厅/阳台/图书馆）+ 5分钟启动
- 地点标签与成功率统计（仅本地）
- 可选：与日历/专注模式联动（见技术）

### I. 通知与提醒（Notification）

**目标**：温和提醒，不制造焦虑
**需求**

- 提醒类型：
  - 每日“领回来”提醒（默认关闭，用户自开）
  - “最小启动”提醒（支持时间窗）
  - 中断回归提醒：如果连续 3 天无启动，提醒一次（不天天催）
- 文案原则：邀请式、非命令式

### J. 设置与安全（Settings & Safety）

**需求**

- 数据导出（JSON/CSV）与删除账号/清空本地数据
- 隐私锁：应用内 PIN/生物识别（可选）
- 青少年友好模式（默认开启）：
  - 不推送深夜提醒
  - 不做刺激性强的社交/竞赛

------

## 2) 用户角色与权限

1. **普通用户（User）**

- 创建/编辑目标、任务、启动步
- 查看全部日志与统计
- 管理隐私与共享范围

1. **支持者（Supporter）**

- 仅能看到用户授权的共享信息
- 发送“轻反馈”（点赞/鼓励语）
- 不能查看私密日志、不能修改用户任务

1. **管理员（Admin/运营后台）**

- 管理模板库、系统公告、违规内容处理（若有UGC）
- 查看匿名化统计（需合规）

1. **访客模式（Guest，可选）**

- 不登录，本地使用核心功能
- 不支持云同步/支持者功能

------

## 3) 信息架构与导航流程（IA & Flow）

### 推荐信息架构（底部四栏）

- **首页**：今日状态 + “领回来” + 最小启动按钮 + 今日三任务
- **任务**：目标/任务列表、拆分、模板库
- **记录**：日志、周复盘、统计图表
- **我的**：支持者、提醒、隐私、安全、导出

### 核心主流程（Happy Path）

1. 打开App → 首页提示“领回来（1分钟）”
2. 选择状态 → 推荐一个“最小启动（≤5分钟）”
3. 一键开始计时 → 完成/中断
4. 完成后：即时奖励 + 记录生成 + 允许休息
5. 次日：根据昨日完成自动推荐更合适的启动步

------

## 4) 关键UI规范与UX要求

### UI 设计规范（Android）

- 遵循 **Material Design 3**（动态色/暗色模式）
- 字体与可读性：正文≥14sp，关键按钮≥16sp
- 无障碍：对比度符合 WCAG AA，支持 TalkBack，触控区域≥48dp

### UX 交互要求

- **一键可达**：从首页到“开始启动”不超过 2 次点击
- **低压力呈现**：默认只展示少量任务；避免红色警告、避免“打卡失败”
- **正向语气系统**：所有提示语以“邀请/允许/可以”表达
- **失败友好**：中断=“我尝试了”，可直接“再来一个更小的”
- **反成瘾设计**：避免无限滚动奖励、避免强刺激音效/弹窗轰炸

------

## 5) 技术实现要求与性能指标（Android）

### 推荐技术栈（示例）

- 客户端：**Kotlin + Jetpack Compose**（或 Flutter 亦可，但此处按原生优先）
- 架构：MVVM + Clean Architecture
- 本地存储：Room + SQLCipher（加密可选）
- 通知：Firebase Cloud Messaging（云同步/跨设备时）或本地 AlarmManager

### 性能指标

- 冷启动：中端机型首屏 < 2.5s
- 页面切换：< 200ms 体感延迟
- 离线可用：核心功能（启动、记录、任务）100%离线
- 耗电控制：后台任务最小化；通知不高频轮询
- 崩溃率：< 0.3%（发布后 7 天滚动）

------

## 6) 数据存储与安全需求

### 数据分类

- 账号数据：昵称、设置项（可选云同步）
- 行为数据：启动记录、任务结构、复盘数据
- 私密数据：羞耻触发/自我对话等（默认仅本地）

### 安全要求

- 本地敏感数据加密（可配置开关，默认开启 PIN/生物识别可选）
- 云同步（如启用）：传输 HTTPS，服务端加密存储
- 最小化采集原则：默认不采集精确位置；地点标签仅手动选择
- 数据删除：提供“一键删除所有数据”与“导出后删除”
- 支持者共享：严格按授权字段输出，随时撤回生效

------

## 7) 测试策略与验收标准

### 测试策略

- 单元测试：任务拆分、XP计算、提醒策略等核心逻辑
- UI 自动化：启动流程、计时器、日志写入、撤回共享
- 集成测试：本地存储一致性、云同步冲突（如启用）
- 兼容性测试：Android 8–15（建议最低 Android 8.0/ API 26）
- 性能测试：启动耗时、内存泄漏、耗电
- 安全测试：本地加密验证、权限最小化、导出与删除正确性
- 无障碍测试：TalkBack、字体放大、暗色模式

### 验收标准（关键用例）

- 用户可在**30秒内**完成首次“领回来→最小启动→记录生成”
- 离线状态下完成一次启动，数据不丢失；联网后（如有云）可正确同步
- 支持者只能看到授权字段；撤回后立即不可见
- 中断启动不会导致负向惩罚；可一键再生成更小任务
- 通知可完全关闭；不出现强制提醒

------

## 8) 发布流程与后续维护计划

### 发布流程（Google Play）

1. 内测版本（Internal Testing）：核心流程与崩溃收敛
2. 封闭测试（Closed Testing）：邀请种子用户，验证“启动次数提升”
3. 公开测试（Open Testing，可选）：优化留存与提醒策略
4. 正式发布（Production）：分阶段灰度（按地区/比例）

### 上线后监控与迭代

- 监控：崩溃率、ANR、冷启动、关键漏斗（打开→启动→完成）
- 关键产品指标：
  - D1/D7 留存
  - 人均每周启动次数
  - 中断后回归率（从“尝试”到“再启动”）
- 迭代节奏：
  - 每 2 周小版本（文案/模板/体验）
  - 每 6–8 周大版本（支持者系统、同步、复盘升级）
- 客服与反馈：
  - App 内反馈入口（截图+日志上传可选）
  - 模板库持续扩展（论文/考试/求职专属）

------



下面是把你当前需求清单落成**可直接开工的开发落地文档（可执行技术方案 + 研发计划）**。默认面向 **Android 原生（Kotlin + Jetpack Compose）**，采用 **离线优先（Offline-first）**，并将“云同步/支持者系统/运营后台”作为可选增强（MVP 可先不做或做轻量版）。

------

# 《领回来 · 一起走》Android 应用开发文档（V1.0）

## 1. 文档信息

- 文档版本：V1.0
- 目标平台：Android 8.0+（API 26+）
- 技术栈：Kotlin、Jetpack Compose、MVVM + Clean Architecture、Room、WorkManager、Hilt、Retrofit（若有后端）
- 产品定位：帮助用户通过“领回来仪式 + 最小启动按钮 + 正向反馈/复盘”建立持续行动循环（非医疗诊断类）

------

## 2. 范围定义

### 2.1 MVP 必做（P0）

1. 引导建档（Onboarding）
2. 首页主流程：领回来仪式 → 最小启动按钮 → 计时/完成/中断
3. 目标/任务/启动步（基础 CRUD + 模板生成）
4. 行动日志（自动生成 + 手动补充）
5. 统计（启动次数、连续天数、回归次数）
6. 本地通知（温和提醒，可完全关闭）
7. 隐私与数据：本地存储、导出/清空

### 2.2 下一期（P1）

- 支持者系统（共享授权字段、轻反馈）
- 多地点挑战（环境切换）与成功率统计
- 周复盘增强（触发条件洞察）
- 云同步（账号登录、跨设备）

### 2.3 暂不做（P2）

- 排行榜/强对比社交
- 强刺激抽奖/成瘾式激励
- 深度内容社区（UGC）与复杂审核

------

## 3. 信息架构与页面导航

### 3.1 底部导航（4 Tab）

- 首页 Home：状态/领回来/最小启动/今日任务
- 任务 Tasks：目标→任务→启动步
- 记录 Logs：日记、周复盘、统计
- 我的 Me：设置、提醒、隐私、导出、（支持者/同步）

### 3.2 核心用户流（必须通）

**打开 App →（可选）领回来 → 生成最小启动 → 开始计时 → 完成/中断 → 自动写入日志 + 奖励反馈 → 返回首页**

------

## 4. 功能模块拆分（工程可落地）

> 建议按“模块化 + Clean Architecture 分层”组织：
> `app`（UI壳） + `core`（通用） + `feature-*`（业务） + `data`（本地/网络）

### 4.1 模块清单

1. `feature-onboarding`：引导建档
2. `feature-home`：首页、领回来仪式、推荐最小启动
3. `feature-microstart`：最小启动生成器、计时器、完成/中断处理
4. `feature-tasks`：目标/任务/启动步管理、模板库
5. `feature-logs`：行动日志、周复盘、统计
6. `feature-settings`：提醒、隐私锁、导出/清空
7. `core-ui`：主题、组件库、导航封装
8. `core-domain`：用例（UseCase）与业务规则
9. `data-local`：Room、DAO、DataStore
10. `data-remote`（可选）：Retrofit API、同步
11. `core-analytics`（可选）：埋点接口（本地可先空实现）

------

## 5. 技术架构与实现方案

### 5.1 架构原则

- **离线优先**：所有核心功能不依赖网络
- **单向数据流**：UI -> Intent -> ViewModel -> UseCase -> Repository -> DB
- **可测试**：业务规则集中在 UseCase；DB/网络通过接口抽象可替换
- **隐私默认**：敏感数据本地保存，云同步用户主动开启

### 5.2 推荐技术选型

- UI：Jetpack Compose + Material 3
- DI：Hilt
- 数据：Room（SQLite） + DataStore（设置项）
- 异步：Kotlin Coroutines + Flow
- 后台任务：WorkManager（通知、同步）
- 网络（可选）：Retrofit + OkHttp
- 安全：
  - 可选 SQLCipher（数据库加密）
  - 生物识别：BiometricPrompt（隐私锁）
- 测试：JUnit5/4、Turbine（Flow）、Compose UI Test、Robolectric（可选）

------

## 6. 数据结构说明（本地数据库优先）

### 6.1 核心实体（Entity）

#### UserProfileEntity

- `id: String`（固定 "local" 或 UUID）
- `nickname: String?`
- `tone: String`（gentle/direct/brief）
- `focusGoalType: String`（study/thesis/job/life…）
- `blockers: List<String>`（拖延/完美主义/害怕评价…）
- `createdAt: Long`
- `updatedAt: Long`

#### GoalEntity（目标）

- `goalId: String`
- `title: String`
- `category: String`
- `isArchived: Boolean`
- `createdAt: Long`
- `updatedAt: Long`

#### MissionEntity（任务）

- `missionId: String`
- `goalId: String`
- `title: String`
- `status: String`（active/done/paused）
- `priority: Int`（1-3）
- `createdAt: Long`
- `updatedAt: Long`

#### StepEntity（启动步）

- `stepId: String`
- `missionId: String`
- `type: String`（LOOK/DO/WALK）
- `title: String`（如：打开文档写标题）
- `durationSec: Int`（默认 60/300/600）
- `isTemplateGenerated: Boolean`
- `createdAt: Long`
- `updatedAt: Long`

#### RitualRecordEntity（领回来记录）

- `ritualId: String`
- `mood: String`（escape/anxious/tired/ok）
- `pickedPart: String`（拖延的我/害怕失败的我…）
- `affirmation: String`
- `createdAt: Long`

#### SessionEntity（启动会话：计时+结果）

- `sessionId: String`
- `stepId: String?`（允许临时启动）
- `startAt: Long`
- `endAt: Long?`
- `plannedDurationSec: Int`
- `actualDurationSec: Int`
- `result: String`（COMPLETED/ABORTED）
- `note: String?`

#### LogEntryEntity（行动日志）

- `logId: String`
- `date: String`（YYYY-MM-DD）
- `startSummary: String`（今日启动）
- `insight: String?`（小成就/灵感）
- `createdAt: Long`

#### StatsSnapshotEntity（可选缓存统计）

- `date: String`
- `startCount: Int`
- `streakDays: Int`
- `returnCount: Int`

#### SettingsEntity（或 DataStore）

- `notificationsEnabled: Boolean`
- `dailyRitualTime: String?`
- `nudgeIf3DaysNoStart: Boolean`
- `privacyLockEnabled: Boolean`
- `biometricEnabled: Boolean`
- `shareEnabled: Boolean`（P1）

------

## 7. 关键业务规则（UseCase 定义）

### 7.1 领回来仪式（Ritual）

- 输入：`mood` + `pickedPart` +（可选）`affirmation`
- 输出：生成一条 `RitualRecord`，并触发“推荐最小启动”
- 规则：
  - affirmation 默认从模板库取（按 tone）
  - 不做负向评价文案

**UseCase：**

- `SaveRitualUseCase(mood, pickedPart, affirmation?)`
- `GetTodayRitualIfExistsUseCase(date)`

### 7.2 最小启动推荐（MicroStart Recommendation）

- 输入：用户状态（mood）、最近会话结果、现有任务列表
- 输出：推荐一个 Step（优先 DO ≤5min，其次 LOOK）
- 规则（优先级从高到低）：
  1. 若近 2 次 ABORTED：推荐 LOOK（60s）
  2. 若任务存在未开始 Step：从该任务挑最短的 DO（≤300s）
  3. 若没有任务：从通用模板生成“临时 Step”（不绑定 mission）

**UseCase：**

- `RecommendStepUseCase(context): StepModel`

### 7.3 会话记录与奖励（Session + XP）

- 完成：写入 Session(COMPLETED) + 写入日志 startSummary（若当天无日志则新建）
- 中断：写入 Session(ABORTED) + 允许“再来一个更小的”
- XP 规则（MVP 简化）：
  - LOOK 完成 +10
  - DO 完成 +20
  - WALK 完成 +30
  - ABORTED +2（鼓励尝试）
- 连续天数：以“当天至少一次 Session（完成或尝试）”为准（避免羞耻清零）

**UseCase：**

- `StartSessionUseCase(stepId?, plannedDurationSec)`
- `FinishSessionUseCase(sessionId, result, actualDurationSec, note?)`
- `ComputeStreakUseCase(dateRange)`

------

## 8. 接口定义（分两类：本地接口 + 可选后端API）

## 8.1 本地 Repository 接口（必须实现）

### ProfileRepository

- `getProfile(): Flow<UserProfile>`
- `saveProfile(profile: UserProfile): Unit`

### TaskRepository

- `getGoals(): Flow<List<Goal>>`
- `createGoal(title, category): GoalId`
- `updateGoal(goal): Unit`
- `getMissions(goalId): Flow<List<Mission>>`
- `createMission(goalId, title, priority): MissionId`
- `getSteps(missionId): Flow<List<Step>>`
- `createStep(missionId, type, title, durationSec): StepId`

### RitualRepository

- `saveRitual(record): Unit`
- `getRitualByDate(date): Flow<RitualRecord?>`

### SessionRepository

- `createSession(stepId?, plannedDurationSec): SessionId`
- `finishSession(sessionId, result, actualDurationSec, note?): Unit`
- `getSessionsByDate(date): Flow<List<Session>>`

### LogRepository

- `getLogByDate(date): Flow<LogEntry?>`
- `upsertLog(date, startSummary?, insight?): Unit`

### SettingsRepository（DataStore）

- `settingsFlow(): Flow<Settings>`
- `updateSettings(patch): Unit`

------

## 8.2 可选后端 API（P1/P2，云同步/支持者/模板下发）

### 认证（可选）

- `POST /v1/auth/anonymous`
  - 返回：`userId`, `token`, `refreshToken`

### 云同步（简化版）

- `POST /v1/sync/push`
  - 请求：`{ deviceId, lastSyncAt, payload: {...} }`
  - 响应：`{ serverTime, conflicts: [...], ack }`
- `GET /v1/sync/pull?since=timestamp`
  - 响应：增量数据

### 支持者共享（P1）

- `POST /v1/share/invite`：生成邀请码
- `POST /v1/share/bind`：支持者绑定
- `POST /v1/share/summary`：上传用户授权的“今日是否启动”
- `GET /v1/share/summary`：支持者查看

> MVP 可以先做“本地分享截图/文本”替代真实后端共享。

------

## 9. UI/UX 实现规范（开发可直接对齐）

### 9.1 Compose 组件规范

- 基础组件封装到 `core-ui`：
  - `PrimaryCTAButton`
  - `CardSection`
  - `MoodSelector`
  - `StepTimerSheet`（底部弹层计时器）
  - `Toast/Snackbar` 统一入口

### 9.2 关键页面 UI 规格（MVP 必须）

#### 首页 HomeScreen

- 顶部：今日状态提示（非强制）
- 模块1：领回来（入口按钮 + 今日已完成提示）
- 模块2：推荐最小启动（主 CTA：开始）
- 模块3：今日任务（最多3条 + “更多”折叠）

交互要求：

- 从打开首页到开始计时 ≤2 次点击
- 计时器支持：暂停、提前完成、标记中断

#### 领回来 RitualScreen（或 BottomSheet）

- 选择 mood（4个）
- 选择“领回的部分”
- affirmation 默认值可一键确认（可编辑）

#### 计时器 TimerSheet

- 显示 step 标题、剩余时间
- 操作：完成 / 中断 / 暂停
- 完成后：奖励弹层（XP + 一句话 + “允许休息”按钮）

#### 任务 TasksScreen

- 目标列表 → 任务列表 → 启动步列表
- 一键“切成最小启动”（自动生成 Steps）

#### 记录 LogsScreen

- 今日两条结构化记录
- 周复盘入口（展示启动次数、连续天数、回归次数）

------

## 10. 开发规范（团队协作与编码标准）

### 10.1 工程规范

- 分层包结构：
  - `ui/`（Compose + state）
  - `presentation/`（ViewModel）
  - `domain/`（UseCase、Model）
  - `data/`（Repo impl、db、network）
- 统一命名：
  - UseCase：动词开头 `RecommendStepUseCase`
  - Flow：以 `...Flow` 结尾
- 异常处理：
  - Repository 不抛裸异常给 UI，使用 Result/Either 或统一错误模型
- 日志：
  - debug 可输出，release 限制敏感信息

### 10.2 Git 与 CI

- 分支：`main` + `develop` + `feature/*`
- PR 必须：
  - 通过单元测试与 lint
  - 至少 1 名 reviewer
- CI（建议）：
  - ktlint/detekt
  - unit tests
  - assembleDebug

### 10.3 文案与安全

- 文案禁止羞辱/贬低用户
- 不提供任何危险行为引导
- “非医疗”提示放在设置-关于

------

## 11. 质量验收标准（可量化）

### 11.1 功能验收（关键用例）

1. 首次安装：30 秒内完成建档并完成一次最小启动（LOOK 或 DO）
2. 完成一次启动会话：Session 写入、日志自动生成、首页统计更新
3. 中断：Session 记为 ABORTED，不出现负向惩罚，可一键推荐更小任务
4. 离线：断网不影响核心流程，重启后数据不丢失
5. 通知：可全部关闭；不会出现高频催促
6. 导出/清空：导出文件包含核心实体；清空后不可恢复（明确提示）

### 11.2 性能验收

- 冷启动首屏 < 2.5s（中端机）
- 首页滚动与切换无明显卡顿（>55fps 体感）
- ANR 0、崩溃率 < 0.3%（上线后监控）

### 11.3 兼容性验收

- Android 8/10/12/14 至少各 1 台真机验证
- 深色模式、字体放大（系统 1.3x）可用

------

## 12. 详细开发步骤（按迭代落地）

### Sprint 0（1周）：工程搭建与基建

- 建立多模块工程结构、导航框架、主题组件库
- Room + DataStore 基础封装
- Hilt 注入、基础日志/错误处理
- 首页骨架与路由完成

产出：

- 可运行空壳 App（4 tab + 导航 + DB 初始化）

### Sprint 1（1周）：核心闭环 V0

- Onboarding：保存 profile
- Ritual：保存 ritual record
- MicroStart：生成临时 step（不依赖任务）
- Timer：会话开始/结束写入 session
- Logs：当天自动生成 startSummary

产出：

- 主闭环跑通：领回来→启动→完成→日志

### Sprint 2（1周）：任务系统与推荐

- Goal/Mission/Step CRUD
- 模板库（本地 JSON）与“一键切片”
- 推荐策略接入：优先从任务 steps 选

产出：

- 用户可创建任务并从任务中启动

### Sprint 3（1周）：统计、提醒、设置、导出

- streak/周统计
- 通知策略（每日仪式提醒、3天无启动提醒）
- 隐私锁（PIN/生物识别可选）
- 数据导出（JSON/CSV）与清空

产出：

- MVP 完整可上线内测

### Sprint 4（可选，1-2周）：体验打磨与测试补齐

- UI 动效与无障碍
- 自动化测试覆盖
- 性能优化与崩溃收敛

------

## 13. 项目时间节点规划（建议 4–6 周 MVP）

- 第1周：Sprint0（基建）
- 第2周：Sprint1（核心闭环）
- 第3周：Sprint2（任务与推荐）
- 第4周：Sprint3（统计/提醒/导出/隐私）
- 第5-6周：灰度内测、修复、上架准备（可选）

里程碑：

- M1：核心闭环可用（第2周末）
- M2：任务系统可用（第3周末）
- M3：MVP 可内测（第4周末）
- M4：可发布版本（第5-6周）

------

## 14. 附录：建议的“模板库”格式（本地 JSON）

用于生成最小启动 steps（MVP 本地静态文件即可）：

- `templateId`
- `category`（thesis/job/study/life）
- `type`（LOOK/DO/WALK）
- `title`
- `durationSec`
- `moodHints`（适配不同心情优先级）

------



下面给出一份**工程级、可直接拆成 Jira/飞书任务**的扩展交付物，包含：

- **(1) 模块化任务分解清单**（每条含：P级、估算、依赖、角色、验收标准/成功指标）
- **(2) MVP 级接口规范**（端点、结构、校验、错误、鉴权）
- **(3) 数据库设计产出物**（完整 DDL、DAO 伪代码、索引策略、关系/约束）
- **(4) ViewModel 架构规范**（State/Intent/Effect、状态转换、错误/加载）

> 说明：产品采用 **Offline-first**，MVP 在**没有后端**也能跑通核心闭环；但为了你要求的“完整 API 端点”，这里提供**MVP 可选后端**（用于模板下发、云同步、支持者 P1 的基础能力）。
> 你可以把 API 作为 **P1** 后端启动项，或把 “模板下发” 作为 MVP 唯一后端能力。

------

# A. Jira/飞书可用的工程任务分解（WBS）

## A0. 任务跟踪最佳实践（建议写进 Jira 模板）

**字段规范**

- Issue 类型：Epic / Story / Task / Sub-task / Bug
- 必填字段：Priority(P0/P1)、Estimate(人天)、Owner、Dependencies、Acceptance Criteria
- Definition of Done（DoD）：
  1. 代码合并主干、通过 CI
  2. 单元测试/关键用例 UI 测试通过
  3. 关键埋点（若启用）已接入
  4. QA 回归通过、无 P0/P1 bug
  5. 更新变更日志与版本号

------

## A1. Epic 列表（建议 1:1 建 Jira Epic）

- **EPIC-APP-01 基建与工程框架**
- **EPIC-APP-02 Onboarding 引导建档**
- **EPIC-APP-03 首页 + 领回来仪式**
- **EPIC-APP-04 最小启动 + 计时会话**
- **EPIC-APP-05 目标/任务/启动步**
- **EPIC-APP-06 日志 + 统计**
- **EPIC-APP-07 通知 + 设置 + 隐私与导出**
- **EPIC-APP-08 质量工程（测试/性能/无障碍）**
- **EPIC-BE-01（可选）MVP 后端：模板/同步/鉴权**
- **EPIC-OPS-01 发布与运维**

------

## A2. 模块化开发任务清单（可直接生成 Jira/飞书 Task）

> 估算单位：**人天（PD）**（1 PD≈1 人/天有效开发）
> 角色建议：PM、Design、Android、Backend、QA、DevOps
> 依赖写法：用任务编号引用，例如依赖 `APP-001`

------

### EPIC-APP-01 基建与工程框架

**APP-001（P0 | 2 PD）工程初始化与模块化结构**

- Owner：Android
- 依赖：无
- 工作内容：
  - 创建多模块工程：app/core-ui/core-domain/data-local/(data-remote 可选)/feature-*
  - 配置 Gradle、版本管理、签名占位
- 验收标准：
  - 项目可运行，4-tab 骨架可打开
  - 模块依赖清晰，无循环依赖
- 成功指标：
  - CI 能构建 Debug 包；启动首屏 < 3s（开发机）

**APP-002（P0 | 1 PD）导航框架与路由规范**

- Owner：Android
- 依赖：APP-001
- 工作内容：Compose Navigation + route 常量 + deep link 占位
- 验收：可在 Home/Tasks/Logs/Me 间切换；支持参数传递（id）
- 指标：导航切换无崩溃

**APP-003（P0 | 2 PD）本地数据层：Room + DataStore 基础封装**

- Owner：Android
- 依赖：APP-001
- 工作内容：
  - Room DB、migration 策略、DAO 基础
  - DataStore 存储 Settings
- 验收：本地 CRUD 可用；升级版本不丢数据（至少支持 v1->v2 空迁移）
- 指标：核心写入成功率 99%（QA 回归）

**APP-004（P0 | 1 PD）DI 与协程规范（Hilt + Dispatcher）**

- Owner：Android
- 依赖：APP-001
- 验收：Repository/UseCase 可注入；IO/Default/Main dispatcher 可替换测试
- 指标：单测可注入 Fake Repo

**APP-005（P1 | 1 PD）错误处理与日志规范（Result/ErrorModel）**

- Owner：Android
- 依赖：APP-003, APP-004
- 验收：UI 不出现裸异常；错误统一映射可国际化
- 指标：Crash-free sessions 提升（上线后）

------

### EPIC-APP-02 Onboarding 引导建档

**APP-010（P0 | 1.5 PD）Onboarding UI + 状态管理**

- Owner：Android + Design（配合）
- 依赖：APP-002
- 验收：30 秒内完成建档流程；可跳过头像
- 指标：首次流程完成率 ≥ 80%（内测）

**APP-011（P0 | 1 PD）Profile 数据模型与存储**

- Owner：Android
- 依赖：APP-003
- 验收：profile 保存/读取成功；重启后保持
- 指标：profile 读写延迟 < 50ms（本地）

**APP-012（P1 | 0.5 PD）文案风格切换（tone: gentle/direct/brief）**

- Owner：Android + PM
- 依赖：APP-011
- 验收：切换后关键页面文案生效
- 指标：无文案缺失/溢出

------

### EPIC-APP-03 首页 + 领回来仪式

**APP-020（P0 | 2 PD）HomeScreen UI（卡片区块 + 主 CTA）**

- Owner：Android + Design
- 依赖：APP-002, APP-011
- 验收：首页展示：领回来入口、推荐启动、今日任务（最多3条）
- 指标：打开到开始启动 ≤2 次点击

**APP-021（P0 | 1.5 PD）领回来仪式（Ritual）流程实现**

- Owner：Android
- 依赖：APP-003, APP-020
- 验收：可选择 mood + pickedPart + affirmation（默认模板）
- 指标：仪式完成率（打开后完成）≥ 60%

**APP-022（P0 | 1 PD）RitualRepository + SaveRitualUseCase**

- Owner：Android
- 依赖：APP-003
- 验收：保存记录；同一天可读取“已完成”
- 指标：日查询耗时 < 30ms

**APP-023（P1 | 1 PD）推荐策略 V1（基于心情与最近中断）**

- Owner：Android（Domain）
- 依赖：APP-022, APP-040（Session 基础）
- 验收：近2次中断→推荐 LOOK；否则 DO 优先
- 指标：中断后“再次启动率”提升（内测观察）

------

### EPIC-APP-04 最小启动 + 计时会话

**APP-040（P0 | 2 PD）计时器 BottomSheet + 会话创建/结束**

- Owner：Android
- 依赖：APP-020, APP-003
- 验收：开始/暂停/完成/中断；写入 Session
- 指标：无 ANR；计时误差 < 1s/分钟

**APP-041（P0 | 1 PD）MicroStart 生成器（临时 Step）**

- Owner：Android（Domain）
- 依赖：APP-040
- 验收：无任务也能一键生成 LOOK/DO 启动步
- 指标：新用户首次启动成功率 ≥ 70%

**APP-042（P0 | 1 PD）完成/中断后的奖励反馈（XP + 文案 + 允许休息）**

- Owner：Android + PM
- 依赖：APP-040
- 验收：完成弹层出现；中断不惩罚，可再生成更小任务
- 指标：完成后返回首页率 ≥ 90%

**APP-043（P1 | 1 PD）会话恢复（App 切后台/重启继续显示）**

- Owner：Android
- 依赖：APP-040
- 验收：后台回来能看到当前会话状态（至少提示“会话未结束”）
- 指标：会话丢失率趋近 0

------

### EPIC-APP-05 目标/任务/启动步

**APP-050（P0 | 2 PD）Goals/Missions/Steps 数据层 + CRUD**

- Owner：Android
- 依赖：APP-003
- 验收：可创建/编辑/完成/归档；列表可观察刷新
- 指标：CRUD 无数据错乱；外键一致

**APP-051（P0 | 2 PD）Tasks UI：目标→任务→启动步三级导航**

- Owner：Android + Design
- 依赖：APP-002, APP-050
- 验收：三级页面可达；创建入口清晰
- 指标：页面加载 < 400ms

**APP-052（P0 | 1 PD）“一键切片”生成 Steps（≤10min 规则）**

- Owner：Android（Domain）
- 依赖：APP-050
- 验收：对 mission 自动生成 LOOK/DO/WALK steps；可编辑
- 指标：生成步骤符合时长规则；无空标题

**APP-053（P1 | 1 PD）模板库（本地 JSON）与按类别推荐**

- Owner：Android + PM
- 依赖：APP-052
- 验收：模板可扩展；按 thesis/job/study/life 推荐
- 指标：模板命中率（推荐使用模板的比例）

------

### EPIC-APP-06 日志 + 统计

**APP-060（P0 | 1.5 PD）日志自动生成（今日启动 + 灵感）**

- Owner：Android
- 依赖：APP-040
- 验收：完成/尝试后当天自动创建/更新 LogEntry
- 指标：日志缺失率 < 1%

**APP-061（P0 | 2 PD）Logs UI：日视图 + 周复盘入口 + 统计卡**

- Owner：Android + Design
- 依赖：APP-060
- 验收：展示今日两条记录；可编辑 insight；周统计可见
- 指标：统计与实际会话一致（QA 10+用例）

**APP-062（P0 | 1.5 PD）统计计算 UseCase（streak/returnCount/startCount）**

- Owner：Android（Domain）
- 依赖：APP-040
- 验收：连续天数以“当天至少一次 session”计算；支持 7/30 天区间
- 指标：计算耗时 < 100ms（本地 30 天数据）

**APP-063（P1 | 1 PD）统计缓存（StatsSnapshot 可选）**

- Owner：Android
- 依赖：APP-062
- 验收：大数据量情况下统计仍流畅
- 指标：滚动无掉帧

------

### EPIC-APP-07 通知 + 设置 + 隐私与导出

**APP-070（P0 | 1.5 PD）设置页：提醒开关/时间窗/隐私基础**

- Owner：Android + Design
- 依赖：APP-003
- 验收：通知可完全关闭；设置持久化
- 指标：设置写入成功率 99%

**APP-071（P0 | 2 PD）通知调度（WorkManager/AlarmManager）**

- Owner：Android
- 依赖：APP-070, APP-062
- 验收：
  - 每日领回来提醒（用户开启才发）
  - 3天无启动提醒（最多每3天一次）
- 指标：无频繁打扰；不在深夜推送（青少年友好默认）

**APP-072（P0 | 1.5 PD）数据导出（JSON/CSV）+ 清空**

- Owner：Android
- 依赖：APP-003, APP-050, APP-060
- 验收：导出包含核心表；清空后不可恢复且提示明确
- 指标：导出文件可被解析；无隐私泄露（仅本地）

**APP-073（P1 | 2 PD）隐私锁（PIN/生物识别）**

- Owner：Android
- 依赖：APP-070
- 验收：启用后进入 App 需解锁；后台回来按策略要求解锁
- 指标：误锁/卡死 0

------

### EPIC-APP-08 质量工程（测试/性能/无障碍）

**APP-080（P0 | 2 PD）单元测试：UseCase 覆盖**

- Owner：Android + QA（协作）
- 依赖：APP-040, APP-062, APP-023
- 验收：关键规则 80%+ 覆盖：推荐、streak、会话写入
- 指标：CI 单测稳定通过

**APP-081（P0 | 2 PD）UI 自动化测试：核心闭环**

- Owner：QA + Android
- 依赖：APP-020, APP-040, APP-060
- 验收：自动跑通：领回来→启动→完成→日志
- 指标：回归耗时下降；关键路径不回退

**APP-082（P1 | 1.5 PD）性能与无障碍验收**

- Owner：QA + Android
- 依赖：APP-061, APP-071
- 验收：冷启动<2.5s（中端机）；TalkBack 可用；暗色模式 OK
- 指标：ANR 0、掉帧可接受

------

### EPIC-BE-01（可选）MVP 后端：模板/同步/鉴权（若做云能力）

**BE-001（P1 | 2 PD）鉴权：匿名注册 + Token 刷新**

- Owner：Backend
- 依赖：无
- 验收：可获取 access/refresh；过期可刷新
- 指标：鉴权失败率低；日志可追踪 traceId

**BE-002（P1 | 2 PD）模板下发 API（版本化 + 增量）**

- Owner：Backend
- 依赖：BE-001（可选）
- 验收：客户端可拉取模板；支持版本号与缓存
- 指标：模板请求 95p < 300ms

**BE-003（P1 | 3 PD）云同步（push/pull + 冲突策略）**

- Owner：Backend
- 依赖：BE-001
- 验收：基础增量同步可用；冲突按 lastWriteWins 或字段级合并
- 指标：同步成功率 99%

**BE-004（P1 | 2 PD）服务端数据模型与迁移**

- Owner：Backend
- 依赖：BE-001
- 验收：表结构可演进；数据可审计（不含敏感内容）
- 指标：无数据丢失

------

### EPIC-OPS-01 发布与运维

**OPS-001（P0 | 1 PD）Android 打包/签名/渠道配置（内测）**

- Owner：Android + DevOps
- 依赖：APP-001
- 验收：可生成内测包，版本号规范
- 指标：内测包可安装覆盖升级

**OPS-002（P0 | 1.5 PD）发布流程：Play Console 内测/灰度**

- Owner：DevOps + PM
- 依赖：OPS-001, APP-081
- 验收：内测→封闭→生产流程跑通
- 指标：发布无阻塞

------

# B. MVP 级接口规范（Backend API Spec）

> 若 MVP 不做后端：仅保留 **模板 JSON 本地**；本节可作为 P1 直接启用。
> Base URL：`https://{host}/api/v1`
> Content-Type：`application/json; charset=utf-8`

## B1. 统一响应/错误格式

### 成功响应

```json
{
  "traceId": "b7f1c9...",
  "data": { }
}
```

### 错误响应（统一）

```json
{
  "traceId": "b7f1c9...",
  "error": {
    "code": "INVALID_ARGUMENT",
    "message": "nickname too long",
    "details": [
      { "field": "nickname", "reason": "max_length_20" }
    ]
  }
}
```

### 错误码规范（示例）

- `UNAUTHORIZED`（401）
- `FORBIDDEN`（403）
- `NOT_FOUND`（404）
- `INVALID_ARGUMENT`（400）
- `CONFLICT`（409）
- `RATE_LIMITED`（429）
- `INTERNAL`（500）

## B2. 认证鉴权

### Header

- `Authorization: Bearer {accessToken}`
- `X-Device-Id: {uuid}`（必填，用于匿名设备识别）
- `X-App-Version: 1.0.0`（必填）

### Token

- `accessToken`：有效期 1h
- `refreshToken`：有效期 30d

------

## B3. API 端点定义（MVP）

### 1) 匿名注册 / 登录

**POST** `/auth/anonymous`

- 请求

```json
{
  "deviceId": "uuid-xxx",
  "platform": "android",
  "appVersion": "1.0.0"
}
```

- 校验
  - deviceId 必填、UUID 格式
- 响应

```json
{
  "traceId": "t",
  "data": {
    "userId": "u_123",
    "accessToken": "jwt...",
    "refreshToken": "rjwt...",
    "expiresInSec": 3600
  }
}
```

### 2) 刷新 token

**POST** `/auth/refresh`

- 请求

```json
{ "refreshToken": "rjwt..." }
```

- 响应同上

------

### 3) 获取模板（支持版本/增量）

**GET** `/templates?sinceVersion=12`

- 鉴权：可选（建议不强制，便于冷启动）
- 响应

```json
{
  "traceId": "t",
  "data": {
    "latestVersion": 15,
    "templates": [
      {
        "templateId": "tmp_thesis_look_001",
        "category": "thesis",
        "type": "LOOK",
        "title": "打开论文文档，只看一眼目录",
        "durationSec": 60,
        "moodHints": ["escape", "anxious"]
      }
    ]
  }
}
```

- 校验规则：
  - `sinceVersion` 非负整数
- 缓存建议：
  - 返回 `ETag` / `Cache-Control: max-age=86400`

------

### 4) 云同步（Push）

**POST** `/sync/push`

- 鉴权：必须
- 请求（增量上传）

```json
{
  "deviceId": "uuid",
  "lastSyncAt": 1730000000000,
  "payload": {
    "userProfile": { "updatedAt": 1730, "nickname": "A", "tone": "gentle" },
    "goals": [{ "goalId": "g1", "updatedAt": 1730, "deleted": false, "data": { "title": "..." } }],
    "missions": [],
    "steps": [],
    "ritualRecords": [],
    "sessions": [],
    "logEntries": []
  }
}
```

- 响应

```json
{
  "traceId": "t",
  "data": {
    "serverTime": 1730000000123,
    "ack": { "accepted": 120, "rejected": 0 },
    "conflicts": [
      {
        "entity": "goal",
        "id": "g1",
        "strategy": "LAST_WRITE_WINS",
        "serverUpdatedAt": 1730000000999
      }
    ]
  }
}
```

- 冲突策略（MVP 建议）：
  - 默认 `LAST_WRITE_WINS`（按 updatedAt）
  - 若客户端 updatedAt 过旧，返回 conflict 列表，客户端拉取再覆盖

------

### 5) 云同步（Pull）

**GET** `/sync/pull?since=1730000000000`

- 鉴权：必须
- 响应

```json
{
  "traceId": "t",
  "data": {
    "serverTime": 1730000000999,
    "changes": {
      "goals": [{ "goalId": "g2", "updatedAt": 1730, "deleted": false, "data": { "title": "..." } }],
      "missions": [],
      "steps": [],
      "sessions": [],
      "logEntries": []
    }
  }
}
```

- 校验：since 必填、毫秒时间戳、>=0

------

## B4. 请求验证规则（通用）

- 字符串长度：
  - `nickname` ≤ 20
  - `title` ≤ 60（Goal/Mission/Step）
  - `note/insight` ≤ 280
- 枚举校验：
  - mood：`escape|anxious|tired|ok`
  - step type：`LOOK|DO|WALK`
  - session result：`COMPLETED|ABORTED`
- 时间戳：
  - 毫秒时间戳，允许误差范围（服务端可校正）
- 速率限制：
  - `/sync/*` 每设备每分钟 ≤ 30 次（可调）
- 安全：
  - 严禁上传敏感内容字段（若产品要求“私密日志仅本地”，服务端应拒绝该字段）

------

# C. 数据库设计产出物（SQLite / Room）

## C1. 完整 DDL（可直接执行）

> SQLite 建议：启动时执行
> `PRAGMA foreign_keys = ON;`

```sql
-- 1) User Profile
CREATE TABLE IF NOT EXISTS user_profile (
  id TEXT PRIMARY KEY NOT NULL,
  nickname TEXT,
  tone TEXT NOT NULL,
  focus_goal_type TEXT NOT NULL,
  blockers TEXT NOT NULL,            -- JSON array string
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 2) Goals
CREATE TABLE IF NOT EXISTS goals (
  goal_id TEXT PRIMARY KEY NOT NULL,
  title TEXT NOT NULL,
  category TEXT NOT NULL,
  is_archived INTEGER NOT NULL DEFAULT 0,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 3) Missions
CREATE TABLE IF NOT EXISTS missions (
  mission_id TEXT PRIMARY KEY NOT NULL,
  goal_id TEXT NOT NULL,
  title TEXT NOT NULL,
  status TEXT NOT NULL,              -- active/done/paused
  priority INTEGER NOT NULL DEFAULT 2,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  FOREIGN KEY (goal_id) REFERENCES goals(goal_id) ON DELETE CASCADE
);

-- 4) Steps
CREATE TABLE IF NOT EXISTS steps (
  step_id TEXT PRIMARY KEY NOT NULL,
  mission_id TEXT,
  type TEXT NOT NULL,                -- LOOK/DO/WALK
  title TEXT NOT NULL,
  duration_sec INTEGER NOT NULL,
  is_template_generated INTEGER NOT NULL DEFAULT 0,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  FOREIGN KEY (mission_id) REFERENCES missions(mission_id) ON DELETE CASCADE
);

-- 5) Ritual records
CREATE TABLE IF NOT EXISTS ritual_records (
  ritual_id TEXT PRIMARY KEY NOT NULL,
  date TEXT NOT NULL,                -- YYYY-MM-DD
  mood TEXT NOT NULL,                -- escape/anxious/tired/ok
  picked_part TEXT NOT NULL,
  affirmation TEXT NOT NULL,
  created_at INTEGER NOT NULL
);

-- 6) Sessions (timer records)
CREATE TABLE IF NOT EXISTS sessions (
  session_id TEXT PRIMARY KEY NOT NULL,
  step_id TEXT,
  date TEXT NOT NULL,                -- YYYY-MM-DD
  start_at INTEGER NOT NULL,
  end_at INTEGER,
  planned_duration_sec INTEGER NOT NULL,
  actual_duration_sec INTEGER NOT NULL DEFAULT 0,
  result TEXT NOT NULL,              -- COMPLETED/ABORTED
  note TEXT,
  FOREIGN KEY (step_id) REFERENCES steps(step_id) ON DELETE SET NULL
);

-- 7) Log entries (daily)
CREATE TABLE IF NOT EXISTS log_entries (
  log_id TEXT PRIMARY KEY NOT NULL,
  date TEXT NOT NULL UNIQUE,          -- one per day
  start_summary TEXT NOT NULL,
  insight TEXT,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 8) Stats snapshot (optional cache)
CREATE TABLE IF NOT EXISTS stats_snapshots (
  date TEXT PRIMARY KEY NOT NULL,
  start_count INTEGER NOT NULL,
  streak_days INTEGER NOT NULL,
  return_count INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 9) Settings kv (if not using DataStore)
CREATE TABLE IF NOT EXISTS settings_kv (
  k TEXT PRIMARY KEY NOT NULL,
  v TEXT NOT NULL,
  updated_at INTEGER NOT NULL
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_missions_goal_id ON missions(goal_id);
CREATE INDEX IF NOT EXISTS idx_steps_mission_id ON steps(mission_id);
CREATE INDEX IF NOT EXISTS idx_sessions_date ON sessions(date);
CREATE INDEX IF NOT EXISTS idx_sessions_step_id ON sessions(step_id);
CREATE INDEX IF NOT EXISTS idx_ritual_date ON ritual_records(date);
```

### 关键约束说明

- `missions.goal_id` 外键级联删除：删除目标自动删除任务/步骤
- `sessions.step_id`：步骤删除后会话保留（`ON DELETE SET NULL`）
- `log_entries.date UNIQUE`：每天只一条日志，支持 upsert 更新
- `blockers`：用 JSON 字符串存数组（Room 通过 TypeConverter）

------

## C2. DAO 伪代码（方法签名、参数、返回类型）

```kotlin
@Dao
interface UserProfileDao {
  @Query("SELECT * FROM user_profile WHERE id = :id LIMIT 1")
  fun observeProfile(id: String = "local"): Flow<UserProfileEntity?>

  @Insert(onConflict = OnConflictStrategy.REPLACE)
  suspend fun upsert(entity: UserProfileEntity)
}

@Dao
interface GoalsDao {
  @Query("SELECT * FROM goals WHERE is_archived = 0 ORDER BY updated_at DESC")
  fun observeActiveGoals(): Flow<List<GoalEntity>>

  @Insert(onConflict = OnConflictStrategy.ABORT)
  suspend fun insert(goal: GoalEntity)

  @Update
  suspend fun update(goal: GoalEntity)

  @Query("UPDATE goals SET is_archived = 1, updated_at = :ts WHERE goal_id = :goalId")
  suspend fun archive(goalId: String, ts: Long)
}

@Dao
interface MissionsDao {
  @Query("SELECT * FROM missions WHERE goal_id = :goalId ORDER BY priority ASC, updated_at DESC")
  fun observeMissions(goalId: String): Flow<List<MissionEntity>>

  @Insert(onConflict = OnConflictStrategy.ABORT)
  suspend fun insert(mission: MissionEntity)

  @Update
  suspend fun update(mission: MissionEntity)

  @Query("UPDATE missions SET status = :status, updated_at = :ts WHERE mission_id = :missionId")
  suspend fun setStatus(missionId: String, status: String, ts: Long)
}

@Dao
interface StepsDao {
  @Query("SELECT * FROM steps WHERE mission_id = :missionId ORDER BY created_at ASC")
  fun observeSteps(missionId: String): Flow<List<StepEntity>>

  @Insert(onConflict = OnConflictStrategy.ABORT)
  suspend fun insert(step: StepEntity)

  @Insert(onConflict = OnConflictStrategy.ABORT)
  suspend fun insertAll(steps: List<StepEntity>)

  @Update
  suspend fun update(step: StepEntity)

  @Query("DELETE FROM steps WHERE step_id = :stepId")
  suspend fun delete(stepId: String)
}

@Dao
interface RitualDao {
  @Query("SELECT * FROM ritual_records WHERE date = :date LIMIT 1")
  fun observeRitual(date: String): Flow<RitualRecordEntity?>

  @Insert(onConflict = OnConflictStrategy.REPLACE)
  suspend fun upsert(entity: RitualRecordEntity)
}

@Dao
interface SessionsDao {
  @Query("SELECT * FROM sessions WHERE date = :date ORDER BY start_at DESC")
  fun observeSessionsByDate(date: String): Flow<List<SessionEntity>>

  @Query("SELECT * FROM sessions ORDER BY start_at DESC LIMIT :limit")
  suspend fun listRecent(limit: Int = 20): List<SessionEntity>

  @Insert(onConflict = OnConflictStrategy.ABORT)
  suspend fun insert(entity: SessionEntity)

  @Query("""
    UPDATE sessions SET end_at = :endAt, actual_duration_sec = :actual, result = :result, note = :note
    WHERE session_id = :sessionId
  """)
  suspend fun finish(sessionId: String, endAt: Long, actual: Int, result: String, note: String?)
}

@Dao
interface LogEntriesDao {
  @Query("SELECT * FROM log_entries WHERE date = :date LIMIT 1")
  fun observeByDate(date: String): Flow<LogEntryEntity?>

  @Insert(onConflict = OnConflictStrategy.REPLACE)
  suspend fun upsert(entity: LogEntryEntity)
}

@Dao
interface StatsDao {
  @Query("SELECT * FROM stats_snapshots WHERE date = :date LIMIT 1")
  suspend fun getSnapshot(date: String): StatsSnapshotEntity?

  @Insert(onConflict = OnConflictStrategy.REPLACE)
  suspend fun upsert(entity: StatsSnapshotEntity)
}
```

------

## C3. 索引策略与性能考量

- 高频查询：
  - Sessions 按 `date` 查询 → `idx_sessions_date`
  - Steps 按 `mission_id` 查询 → `idx_steps_mission_id`
  - Missions 按 `goal_id` 查询 → `idx_missions_goal_id`
  - Ritual 按 `date` 查询 → `idx_ritual_date`
- 统计计算建议：
  - 7/30 天窗口用 `WHERE date BETWEEN ...`（需保证 date 格式一致）
  - 大量 sessions 时：可引入 `stats_snapshots` 缓存（P1）
- Room 建议：
  - 使用事务 `@Transaction` 包裹“完成会话 + 更新日志 + 更新统计缓存”的写入

------

## C4. 数据关系图与约束（文本版 ERD）

- `goals (1) —— (N) missions`（missions.goal_id FK，CASCADE）
- `missions (1) —— (N) steps`（steps.mission_id FK，CASCADE）
- `steps (1) —— (N) sessions`（sessions.step_id FK，SET NULL）
- `log_entries` 按 `date` 唯一（每天 1 条）
- `ritual_records` 按 `date` 推荐 1 条（本设计允许 REPLACE 覆盖）

------

# D. ViewModel 架构规范（MVI/MVVM 可落地）

> 推荐统一采用 **MVI 风格**：
>
> - `UiState`（可序列化、可恢复）
> - `UiIntent`（用户交互/系统事件输入）
> - `UiEffect`（一次性事件：导航/Toast）
> - 通过 reducer 明确状态转换，便于测试与回归

------

## D1. 通用基础结构（建议写到 core-ui/presentation）

```kotlin
interface UiIntent
interface UiEffect

data class UiError(
  val code: String,
  val message: String,
  val recoverable: Boolean = true
)

data class LoadingState(
  val isLoading: Boolean,
  val reason: String? = null
)
```

------

## D2. HomeViewModel（核心路径）

### UiState（覆盖所有 UI 状态）

```kotlin
data class HomeUiState(
  val todayDate: String,
  val profileLoaded: Boolean,
  val ritualDoneToday: Boolean,
  val recommendedStep: StepUiModel?,
  val topTasks: List<MissionUiModel>,
  val statsCard: StatsUiModel?,
  val loading: LoadingState = LoadingState(false),
  val error: UiError? = null
)
```

### Intent（用户交互/系统事件）

```kotlin
sealed interface HomeIntent : UiIntent {
  data object OnEnter : HomeIntent
  data object OnClickRitual : HomeIntent
  data object OnClickStartRecommended : HomeIntent
  data class OnSelectMission(val missionId: String) : HomeIntent
  data object OnRefresh : HomeIntent
}
```

### Effect（一次性事件）

```kotlin
sealed interface HomeEffect : UiEffect {
  data class Navigate(val route: String) : HomeEffect
  data class ShowSnackbar(val message: String) : HomeEffect
}
```

### 状态转换规则（关键）

- `OnEnter`：
  - loading=true → 拉 profile/今日 ritual/推荐 step/统计/今日任务 → loading=false
- `OnClickRitual`：
  - emit Navigate(RitualRoute)
- `OnClickStartRecommended`：
  - 若 recommendedStep!=null → Navigate(TimerRoute(stepId))
  - 否则 error=可恢复错误，并 ShowSnackbar("先生成一个最小启动")

### 错误与加载处理

- 所有 UseCase 调用统一 try/catch 映射 `UiError`
- recoverable=true 时提供“重试”按钮（Home 上可见）

------

## D3. RitualViewModel

### State

```kotlin
data class RitualUiState(
  val mood: Mood? = null,
  val pickedPart: String = "",
  val affirmation: String = "",
  val canSubmit: Boolean = false,
  val loading: LoadingState = LoadingState(false),
  val error: UiError? = null
)
```

### Intent

```kotlin
sealed interface RitualIntent : UiIntent {
  data class SelectMood(val mood: Mood) : RitualIntent
  data class InputPickedPart(val text: String) : RitualIntent
  data class InputAffirmation(val text: String) : RitualIntent
  data object Submit : RitualIntent
  data object LoadDefaultAffirmation : RitualIntent
}
```

### 转换规则

- 当 mood != null 且 pickedPart 非空 → canSubmit=true
- Submit：
  - loading=true → SaveRitualUseCase → loading=false → NavigateBack + 通知 Home 刷新推荐

------

## D4. TimerViewModel（会话）

### State

```kotlin
data class TimerUiState(
  val sessionId: String? = null,
  val stepTitle: String = "",
  val plannedSec: Int,
  val remainingSec: Int,
  val isRunning: Boolean,
  val result: SessionResult? = null,
  val rewardXp: Int = 0,
  val loading: LoadingState = LoadingState(false),
  val error: UiError? = null
)
```

### Intent

```kotlin
sealed interface TimerIntent : UiIntent {
  data object Start : TimerIntent
  data object Pause : TimerIntent
  data object Resume : TimerIntent
  data object Complete : TimerIntent
  data object Abort : TimerIntent
  data class Tick(val remainingSec: Int) : TimerIntent
}
```

### 状态转换（必须清晰）

- Start：
  - createSession → sessionId 设置 → isRunning=true
- Tick：
  - remainingSec 更新（UI 刷新）
- Complete/Abort：
  - finishSession(result) → result 设置 → rewardXp 计算 → 弹出 RewardSheet（Effect）

### 错误处理

- 若 finish 失败：error=recoverable，提供“再次提交完成/中断”按钮（防止数据丢失）

------

## D5. TasksViewModel / LogsViewModel / SettingsViewModel（要点）

- 每个 VM 都要有：
  - `loading`（进入/刷新）
  - `error`（可恢复）
  - `Effect.Navigate/Toast`
- 列表页推荐分页/懒加载（MVP 可不做），但必须避免主线程 IO

------

# E. “可直接创建任务”的输出格式建议（复制到 Jira 描述即可）

你可以把每个任务条目按下面模板粘贴：

**标题**：APP-040 计时器 BottomSheet + 会话创建/结束
**优先级**：P0
**估算**：2 PD
**Owner**：Android
**依赖**：APP-020, APP-003
**描述**：…
**验收标准**：…
**成功指标**：…

------

